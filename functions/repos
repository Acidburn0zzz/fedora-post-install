#!/bin/bash

# Add RPM Fusion
function add_rpmfusion() {
	echo_message title "Starting 'add_rpmfusion' function"
	# Variables
	REPONAME="RPM Fusion ($@)"
	VERSION="$@"
	if [[ "$VERSION" = "free" ]] || [[ "$VERSION" = "nonfree" ]] ; then
		# Check
		if [ -e /etc/yum.repos.d/rpmfusion-$VERSION.repo ]; then
			echo_message info 'Repository already added.'
			whiptail --msgbox "The $REPONAME repository is already added. Proceeding." 8 78
		else
			# Add repository
			echo_message info 'Adding repository...'
			elevate_privilege "dnf install https://download1.rpmfusion.org/$VERSION/fedora/rpmfusion-$VERSION-release-$(rpm -E %fedora).noarch.rpm"
			echo_message success 'Done.'
			whiptail --title "Finished" --msgbox "$REPONAME repository has been added." 8 78
		fi
	else
		echo_message error "Not a correct RPM Fusion repository. Aborting..."
		# Draw window
		whiptail --msgbox "Not a correct RPM Fusion repository. Sorry, try again." --title "Oops" 8 64
	fi
}

# Add Flatpak Repo
function add_flatpak_repo() {
	echo_message title "Starting 'add_flatpak_repo' function"
	# Check
	check_flatpak_repo $1
	EXITSTATUS=$?
	# If repo is added
	if [ $EXITSTATUS = 0 ]; then
		echo_message info 'Repository already added.'
		whiptail --msgbox "The $1 repository is already added. Proceeding." 8 78
	else
		# Add repository
		echo_message info 'Adding flatpak repository...'
		flatpak remote-add --if-not-exists $1 $2
		echo_message success 'Done.'
		whiptail --title "Finished" --msgbox "The '$1' repository has been added." 8 78
	fi
}

# Add Repositories
function repositories {
	echo_message title "Starting 'repositories' function"
	# check exit status
	EXITSTATUS="0"
	while [ "$EXITSTATUS" -eq 0 ]; do
		# Draw window
		REPOS=$(eval `resize` && whiptail \
			--notags \
			--title "Third-Party Repositories" \
			--menu "\nWhat third-party repositories would you like to add?" \
			--ok-button "Install" \
			--cancel-button "Go Back" \
			$LINES $COLUMNS $(( $LINES - 12 )) \
			"rpmfusion_free"		"RPM Fusion (Free)" \
			"rpmfusion_nonfree"		"RPM Fusion (Non-free)" \
			"flathub"				"FlatHub" \
			3>&1 1>&2 2>&3)

		case "${REPOS}" in
		# RPM Fusion Free
		rpmfusion_free)
			add_rpmfusion free
			repositories
		;;
		# RPM Fusion Non-free
		rpmfusion_nonfree)
			add_rpmfusion nonfree
			repositories
		;;
		# FlatHub
		flathub)
			REPONAME="flathub"
			REPO="https://dl.flathub.org/repo/flathub.flatpakrepo"
			add_flatpak_repo $REPONAME $REPO
			repositories
		;;
		# Go Back
		*) status=1
			main
		;;
		esac
	done
}